name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.26'
  DOCKER_IMAGE: goip
  DOCKER_TAG: latest

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Run go mod verify
      run: go mod verify

    - name: Run tests
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        chmod +x ./build/docker-build.sh
        ./build/docker-build.sh -n ${{ env.DOCKER_IMAGE }} -v ${{ env.DOCKER_TAG }}

    - name: Start Redis for testing
      run: |
        docker run -d \
          --name redis-test \
          -p 6379:6379 \
          redis:7-alpine

    - name: Wait for Redis to be ready
      run: |
        timeout 30 bash -c 'until docker exec redis-test redis-cli ping | grep -q PONG; do sleep 1; done'

    - name: Download MaxMind test database
      run: |
        # 建立測試用的空資料目錄（生產環境需要真實的 MaxMind 資料庫）
        # 這裡只是為了驗證 Docker 映像建置正確，實際功能測試需要真實資料庫
        mkdir -p test-data
        echo "Note: Skipping functional tests - MaxMind database required for full testing"
        echo "Docker image built successfully!"

    - name: Verify Docker image
      run: |
        # 驗證映像存在
        docker images | grep ${{ env.DOCKER_IMAGE }}

        # 檢查映像元數據
        docker inspect ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} > /dev/null

        echo "Docker image verification passed!"

    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== GoIP Logs ==="
        docker logs goip-test || true
        echo "=== Redis Logs ==="
        docker logs redis-test || true

    - name: Cleanup
      if: always()
      run: |
        docker stop goip-test redis-test || true
        docker rm goip-test redis-test || true

  lint:
    name: Run Linters
    runs-on: ubuntu-latest
    continue-on-error: true  # 允許 lint 失敗不影響整體建置

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m
      continue-on-error: true  # golangci-lint 可能不支援最新 Go 版本
